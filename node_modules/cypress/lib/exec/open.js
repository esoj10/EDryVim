"use strict";

const debug = require('debug')('cypress:cli');

const util = require('../util');

const spawn = require('./spawn');

const verify = require('../tasks/verify');

const {
  processTestingType,
  checkConfigFile
} = require('./shared');

<<<<<<< HEAD
const processOpenOptions = options => {
=======
const {
  exitWithError
} = require('../errors');
/**
 * Maps options collected by the CLI
 * and forms list of CLI arguments to the server.
 *
 * Note: there is lightweight validation, with errors
 * thrown synchronously.
 *
 * @returns {string[]} list of CLI arguments
 */


const processOpenOptions = (options = {}) => {
>>>>>>> 98cdbff85bc707f2f8626211a7c40aa8ac6382ed
  if (!util.isInstalledGlobally() && !options.global && !options.project) {
    options.project = process.cwd();
  }

  const args = [];

  if (options.config) {
    args.push('--config', options.config);
  }

  if (options.configFile !== undefined) {
<<<<<<< HEAD
=======
    checkConfigFile(options);
>>>>>>> 98cdbff85bc707f2f8626211a7c40aa8ac6382ed
    args.push('--config-file', options.configFile);
  }

  if (options.browser) {
    args.push('--browser', options.browser);
  }

  if (options.env) {
    args.push('--env', options.env);
  }

  if (options.port) {
    args.push('--port', options.port);
  }

  if (options.project) {
    args.push('--project', options.project);
  }

<<<<<<< HEAD
  args.push(...processTestingType(options.testingType));
=======
  if (options.global) {
    args.push('--global', options.global);
  }

  if (options.inspect) {
    args.push('--inspect');
  }

  if (options.inspectBrk) {
    args.push('--inspectBrk');
  }

  args.push(...processTestingType(options));
>>>>>>> 98cdbff85bc707f2f8626211a7c40aa8ac6382ed
  debug('opening from options %j', options);
  debug('command line arguments %j', args);
  return args;
};

module.exports = {
  processOpenOptions,

  start(options = {}) {
<<<<<<< HEAD
    const args = processOpenOptions(options);

=======
>>>>>>> 98cdbff85bc707f2f8626211a7c40aa8ac6382ed
    function open() {
      try {
        const args = processOpenOptions(options);
        return spawn.start(args, {
          dev: options.dev,
          detached: Boolean(options.detached)
        });
      } catch (err) {
        if (err.details) {
          return exitWithError(err.details)();
        }

        throw err;
      }
    }

    if (options.dev) {
      return open();
    }

    return verify.start().then(open);
  }

};